{"status":{},"contains_secrets":false,"product_version":"3.3.1.1","spec":{"description":"","resources":{"client_attrs":{"None":{"y":-1003.6204814397,"x":360.2091299849},"4aff8c30_deployment":{"y":-1149.3387822732,"x":-79.1430905227},"9df14f84_deployment":{"y":-1026.0253049295,"x":119.3927575272},"decb8265_deployment":{"y":-1088.616780016,"x":403.9888525669},"8ff9c0f1_deployment":{"y":-674.5699035844,"x":132.950623632},"d9d0f80c_deployment":{"y":-869.2688941119,"x":394.4684887834}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Boostrap"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"3b8701f6_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"244932b5_runbook","main_task_local_reference":{"kind":"app_task","name":"3b8701f6_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"CHECK_VAR","value":"@@{Openshift_LB_DNS.LB_DNS_STATUS}@@","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Boostrap"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Delete DNS Entry"}],"name":"3fddfa76_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Boostrap"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Delete DNS Entry","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"a7246c3d_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"3b982661_runbook","main_task_local_reference":{"kind":"app_task","name":"3fddfa76_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Boostrap"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"267fcd78_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"292034ce_runbook","main_task_local_reference":{"kind":"app_task","name":"267fcd78_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Boostrap"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"5c64d685_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"4fcf4ddc_runbook","main_task_local_reference":{"kind":"app_task","name":"5c64d685_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Boostrap"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"cb5d5768_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"06ce90e3_runbook","main_task_local_reference":{"kind":"app_task","name":"cb5d5768_dag"},"variable_list":[]},"name":"action_restart"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Get LB Address"},{"kind":"app_task","name":"Register Bootstrap into LoadBalancer"}],"name":"1aab1578_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Get LB Address"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Register Bootstrap into LoadBalancer"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Boostrap"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Get LB Address","attrs":{"exit_status":[],"script":"print \"LB_TARGET=@@{LB_DNS.address}@@\"","eval_variables":["LB_TARGET"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Boostrap"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Register Bootstrap into LoadBalancer","attrs":{"script":"echo \"set server machine-config-server\/bootstrap addr @@{address}@@\" | socat stdio tcp4-connect:@@{LB_TARGET}@@:9999\necho \"set server machine-config-server\/bootstrap state ready\" | socat stdio tcp4-connect:@@{LB_TARGET}@@:9999\n\necho \"set server openshift-api-server\/bootstrap addr @@{address}@@\" | socat stdio tcp4-connect:@@{LB_TARGET}@@:9999\necho \"set server openshift-api-server\/bootstrap state ready\" | socat stdio tcp4-connect:@@{LB_TARGET}@@:9999\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"e8e1548e_runbook","main_task_local_reference":{"kind":"app_task","name":"1aab1578_dag"},"variable_list":[]},"name":"Register Bootstrap into LoadBalancer"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Create DNS Entry"}],"name":"80422709_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Boostrap"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create DNS Entry","attrs":{"script":"## Configure ssh agent\nSSH_CRED=\"@@{CRED.secret}@@\"\neval `ssh-agent -s`\nssh-add - <<<\"${SSH_CRED}\"\n\n## Update DNS zones and LB config for Bootstrap ###\nssh core@@@{LB_DNS.address}@@ -o StrictHostKeyChecking=no -o UserKnownHostsFile=\/dev\/null << EOF\necho \"@@{address}@@ bootstrap.@@{OPENSHIFT_SUBDOMAIN}@@.@@{BASE_DOMAIN}@@\" | sudo tee -a \/etc\/hosts\nEOF","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"88af57fe_runbook","main_task_local_reference":{"kind":"app_task","name":"80422709_dag"},"variable_list":[]},"name":"Create DNS Entry"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"86ab36cf_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"a7246c3d_runbook","main_task_local_reference":{"kind":"app_task","name":"86ab36cf_dag"},"variable_list":[]},"name":"Delete DNS Entry"}],"depends_on_list":[{"kind":"app_service","name":"LB_DNS"}],"name":"Boostrap","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"BOOTSTRAP_STATUS","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"LB_TARGET","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"68f2a41b_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"afc7eb2c_runbook","main_task_local_reference":{"kind":"app_task","name":"68f2a41b_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Delete DNS Entry"},{"kind":"app_task","name":"Remove Master from LoadBalancer"}],"name":"6a320be2_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Delete DNS Entry"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Remove Master from LoadBalancer"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Delete DNS Entry","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"6b1ca7a2_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Remove Master from LoadBalancer","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"a0c79988_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"d8410e81_runbook","main_task_local_reference":{"kind":"app_task","name":"6a320be2_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"8826904c_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"ddbfb95a_runbook","main_task_local_reference":{"kind":"app_task","name":"8826904c_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"569d8b62_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"44394b32_runbook","main_task_local_reference":{"kind":"app_task","name":"569d8b62_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"46a1155f_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"bd4aacc4_runbook","main_task_local_reference":{"kind":"app_task","name":"46a1155f_dag"},"variable_list":[]},"name":"action_restart"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Get LB Address"},{"kind":"app_task","name":"Register Master into LoadBalancer"}],"name":"bfde03b9_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Get LB Address"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Register Master into LoadBalancer"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Get LB Address","attrs":{"exit_status":[],"script":"print \"LB_TARGET=@@{LB_DNS.address}@@\"","eval_variables":["LB_TARGET"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Register Master into LoadBalancer","attrs":{"script":"echo \"set server machine-config-server\/master@@{calm_array_index}@@ addr @@{address}@@\" | socat stdio tcp4-connect:@@{LB_TARGET}@@:9999\necho \"set server machine-config-server\/master@@{calm_array_index}@@ state ready\" | socat stdio tcp4-connect:@@{LB_TARGET}@@:9999\n\necho \"set server openshift-api-server\/master@@{calm_array_index}@@ addr @@{address}@@\" | socat stdio tcp4-connect:@@{LB_TARGET}@@:9999\necho \"set server openshift-api-server\/master@@{calm_array_index}@@ state ready\" | socat stdio tcp4-connect:@@{LB_TARGET}@@:9999","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"d9221bb7_runbook","main_task_local_reference":{"kind":"app_task","name":"bfde03b9_dag"},"variable_list":[]},"name":"Register Master into LoadBalancer"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Remove Master from LoadBalancer"}],"name":"e518a5f5_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Remove Master from LoadBalancer","attrs":{"script":"echo \"set server machine-config-server\/master@@{calm_array_index}@@ state maint\" | socat stdio tcp4-connect:@@{LB_TARGET}@@:9999\n\necho \"set server openshift-api-server\/master@@{calm_array_index}@@ state maint\" | socat stdio tcp4-connect:@@{LB_TARGET}@@:9999","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"a0c79988_runbook","main_task_local_reference":{"kind":"app_task","name":"e518a5f5_dag"},"variable_list":[]},"name":"Remove Master from LoadBalancer"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Create DNS Entry"}],"name":"8bcf7e22_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create DNS Entry","attrs":{"script":"## Configure ssh agent\nSSH_CRED=\"@@{CRED.secret}@@\"\neval `ssh-agent -s`\nssh-add - <<<\"${SSH_CRED}\"\n\n## Update DNS zones and LB config for Bootstrap ###\nssh core@@@{LB_DNS.address}@@ -o StrictHostKeyChecking=no -o UserKnownHostsFile=\/dev\/null << EOF\necho \"@@{address}@@ master-@@{calm_array_index}@@.@@{OPENSHIFT_SUBDOMAIN}@@.@@{BASE_DOMAIN}@@\" | sudo tee -a \/etc\/hosts\nEOF","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"5e78714b_runbook","main_task_local_reference":{"kind":"app_task","name":"8bcf7e22_dag"},"variable_list":[]},"name":"Create DNS Entry"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Delete DNS Entry"}],"name":"3ec572c9_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Delete DNS Entry","attrs":{"script":"## Configure ssh agent\nSSH_CRED=\"@@{CRED.secret}@@\"\neval `ssh-agent -s`\nssh-add - <<<\"${SSH_CRED}\"\n\n## Update DNS zones and LB config\nssh core@@@{LB_TARGET}@@ -o StrictHostKeyChecking=no -o UserKnownHostsFile=\/dev\/null << EOF\nsudo sed -i '\/master-@@{calm_array_index}@@\/d' \/etc\/hosts\nEOF","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"6b1ca7a2_runbook","main_task_local_reference":{"kind":"app_task","name":"3ec572c9_dag"},"variable_list":[]},"name":"Delete DNS Entry"}],"depends_on_list":[{"kind":"app_service","name":"LB_DNS"}],"name":"Master","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"MASTER_STATUS","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"LB_TARGET","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"LB_DNS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"df22df50_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"624885aa_runbook","main_task_local_reference":{"kind":"app_task","name":"df22df50_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"LB_DNS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"b6b8e7f8_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"c624baa4_runbook","main_task_local_reference":{"kind":"app_task","name":"b6b8e7f8_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"LB_DNS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"afbe47d3_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"634da80b_runbook","main_task_local_reference":{"kind":"app_task","name":"afbe47d3_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"LB_DNS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"c1e710f3_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"c5e9be4b_runbook","main_task_local_reference":{"kind":"app_task","name":"c1e710f3_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"LB_DNS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"e9f29ce8_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"84dbf71c_runbook","main_task_local_reference":{"kind":"app_task","name":"e9f29ce8_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"LB_DNS","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"ST","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"c465827e_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"96b11ed4_runbook","main_task_local_reference":{"kind":"app_task","name":"c465827e_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"168fff19_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"27198955_runbook","main_task_local_reference":{"kind":"app_task","name":"168fff19_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Show Login Information"}],"name":"c516d21c_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Show Login Information","attrs":{"script":"print \"Installation completed\"\nprint \"For logging into Console please use the following URL:\"\nprint \"https:\/\/console-openshift-console.apps.{}.{}\".format('@@{OPENSHIFT_SUBDOMAIN}@@','@@{BASE_DOMAIN}@@')\nprint \"Credentials: kubeadmin \/ {}\".format(base64.b64decode('@@{KUBEADMINB64}@@'))\nprint \"For CLI access you can also connect to LB_DNS-Console.\"\nprint \"Please run 'export KUBECONFIG=~\/openshift\/auth\/kubeconfig' before using OC CLI Tool\"","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"15c8346b_runbook","main_task_local_reference":{"kind":"app_task","name":"c516d21c_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"715f1ce2_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"afe012b6_runbook","main_task_local_reference":{"kind":"app_task","name":"715f1ce2_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"97a5f3ca_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"0b751606_runbook","main_task_local_reference":{"kind":"app_task","name":"97a5f3ca_dag"},"variable_list":[]},"name":"action_restart"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Remove Bootstrap from LoadBalancer"}],"name":"0dca6f09_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Remove Bootstrap from LoadBalancer","attrs":{"script":"echo \"set server machine-config-server\/bootstrap state maint\" | socat stdio tcp4-connect:@@{LB_DNS.address}@@:9999\necho \"set server openshift-api-server\/bootstrap state maint\" | socat stdio tcp4-connect:@@{LB_DNS.address}@@:9999\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"a9b5306a_runbook","main_task_local_reference":{"kind":"app_task","name":"0dca6f09_dag"},"variable_list":[]},"name":"Remove Bootstrap from LoadBalancer"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Save HAProxy State"}],"name":"cb078ef6_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Save HAProxy State","attrs":{"script":"echo \"show servers state\" | socat stdio tcp4-connect:127.0.0.1:9999 | sudo tee \/etc\/haproxy\/server_state","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"6f578655_runbook","main_task_local_reference":{"kind":"app_task","name":"cb078ef6_dag"},"variable_list":[]},"name":"Save HAProxy State"}],"depends_on_list":[],"name":"OS_Status_Check","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"OCP_STATUS","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"68f2a41b_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"afc7eb2c_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"68f2a41b_dag_cloned_1"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Delete DNS Entry"},{"kind":"app_task","name":"Remove Worker from LoadBalancer"}],"name":"6a320be2_dag_cloned_1","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Delete DNS Entry"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Remove Worker from LoadBalancer"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Delete DNS Entry","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"f926d7b3_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Remove Worker from LoadBalancer","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"f27499fb_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"d8410e81_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"6a320be2_dag_cloned_1"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"8826904c_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"ddbfb95a_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"8826904c_dag_cloned_1"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"569d8b62_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"44394b32_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"569d8b62_dag_cloned_1"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"46a1155f_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"bd4aacc4_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"46a1155f_dag_cloned_1"},"variable_list":[]},"name":"action_restart"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Get LB Address"},{"kind":"app_task","name":"Register Worker into LoadBalancer"}],"name":"4faf2699_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Get LB Address"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Register Worker into LoadBalancer"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Get LB Address","attrs":{"exit_status":[],"script":"print \"LB_TARGET=@@{LB_DNS.address}@@\"","eval_variables":["LB_TARGET"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Register Worker into LoadBalancer","attrs":{"script":"echo \"set server ingress-http\/worker@@{calm_array_index}@@ addr @@{address}@@\" | socat stdio tcp4-connect:@@{LB_TARGET}@@:9999\necho \"set server ingress-http\/worker@@{calm_array_index}@@ state ready\" | socat stdio tcp4-connect:@@{LB_TARGET}@@:9999\n\necho \"set server ingress-https\/worker@@{calm_array_index}@@ addr @@{address}@@\" | socat stdio tcp4-connect:@@{LB_TARGET}@@:9999\necho \"set server ingress-https\/worker@@{calm_array_index}@@ state ready\" | socat stdio tcp4-connect:@@{LB_TARGET}@@:9999","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"bd1a1b17_runbook","main_task_local_reference":{"kind":"app_task","name":"4faf2699_dag"},"variable_list":[]},"name":"Register Worker into LoadBalancer"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Remove Worker from LoadBalancer"}],"name":"8d175b65_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Remove Worker from LoadBalancer","attrs":{"script":"echo \"set server ingress-http\/worker@@{calm_array_index}@@ state maint\" | socat stdio tcp4-connect:@@{LB_TARGET}@@:9999\n\necho \"set server ingress-https\/worker@@{calm_array_index}@@ state maint\" | socat stdio tcp4-connect:@@{LB_TARGET}@@:9999","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"f27499fb_runbook","main_task_local_reference":{"kind":"app_task","name":"8d175b65_dag"},"variable_list":[]},"name":"Remove Worker from LoadBalancer"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Create DNS Entry"}],"name":"f479d3a0_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create DNS Entry","attrs":{"script":"## Configure ssh agent\nSSH_CRED=\"@@{CRED.secret}@@\"\neval `ssh-agent -s`\nssh-add - <<<\"${SSH_CRED}\"\n\n## Update DNS zones and LB config for Bootstrap ###\nssh core@@@{LB_DNS.address}@@ -o StrictHostKeyChecking=no -o UserKnownHostsFile=\/dev\/null << EOF\necho \"@@{address}@@ worker-@@{calm_array_index}@@.@@{OPENSHIFT_SUBDOMAIN}@@.@@{BASE_DOMAIN}@@\" | sudo tee -a \/etc\/hosts\nEOF","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"57e200d4_runbook","main_task_local_reference":{"kind":"app_task","name":"f479d3a0_dag"},"variable_list":[]},"name":"Create DNS Entry"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Delete DNS Entry"}],"name":"36091e6e_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Delete DNS Entry","attrs":{"script":"## Configure ssh agent\nSSH_CRED=\"@@{CRED.secret}@@\"\neval `ssh-agent -s`\nssh-add - <<<\"${SSH_CRED}\"\n\n## Update DNS zones and LB config\nssh core@@@{LB_TARGET}@@ -o StrictHostKeyChecking=no -o UserKnownHostsFile=\/dev\/null << EOF\nsudo sed -i '\/worker-@@{calm_array_index}@@\/d' \/etc\/hosts\nEOF","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"f926d7b3_runbook","main_task_local_reference":{"kind":"app_task","name":"36091e6e_dag"},"variable_list":[]},"name":"Delete DNS Entry"}],"depends_on_list":[{"kind":"app_service","name":"LB_DNS"}],"name":"Worker","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"WORKER_STATUS","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"LB_TARGET","value":"","label":"","attrs":{"type":""},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}],"description":""}],"substrate_definition_list":[{"description":"","action_list":[{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"bootstrap"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Create Subnetref"}],"name":"468d993e_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"bootstrap"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create Subnetref","attrs":{"exit_status":[],"script":"subnet_ref={\n                \"kind\": \"subnet\",\n                \"uuid\": \"@@{SUBNET_REF}@@\"\n              }\nprint 'subnet_ref=',json.dumps(subnet_ref)","eval_variables":["subnet_ref"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"13835fd4_runbook","main_task_local_reference":{"kind":"app_task","name":"468d993e_dag"},"variable_list":[]},"name":"pre_action_create"},{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"bootstrap"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"12f3c182_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"89355d8f_runbook","main_task_local_reference":{"kind":"app_task","name":"12f3c182_dag"},"variable_list":[]},"name":"post_action_delete"}],"type":"AHV_VM","name":"bootstrap","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"30","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"CRED"}},"editables":{"readiness_probe":{"retries":true,"delay_secs":true,"timeout_secs":null},"create_spec":{"resources":{"nic_list":{"0":{"subnet_reference":true}},"disk_list":{"1":{"disk_size_mib":true}}}}},"os_type":"Linux","create_spec":{"name":"bootstrap-@@{calm_array_index}@@-@@{LB_DNS.ST}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"@@{subnet_ref.uuid}@@"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":4,"gpu_list":[],"memory_size_mib":16384,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":null,"power_state":"ON","type":"","account_uuid":"a0c4dc60-12c4-4199-b476-ddde6a8b9dba","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"IDE"}},"type":"","boot_type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"app_package","type":"","name":"RHCOS47_BOOTSTRAP","uuid":"bd750449-d7c5-4ed3-b539-06db21eaf37c"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"IDE"},"device_type":"CDROM"}},{"data_source_reference":null,"type":"","disk_size_mib":102400,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"master"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Create Subnetref"}],"name":"44e5df8c_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create Subnetref","attrs":{"exit_status":[],"script":"subnet_ref={\n                \"kind\": \"subnet\",\n                \"uuid\": \"@@{SUBNET_REF}@@\"\n              }\nprint 'subnet_ref=',json.dumps(subnet_ref)","eval_variables":["subnet_ref"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"42f1914a_runbook","main_task_local_reference":{"kind":"app_task","name":"44e5df8c_dag"},"variable_list":[]},"name":"pre_action_create"},{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"a5d879f9_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"36e159ad_runbook","main_task_local_reference":{"kind":"app_task","name":"a5d879f9_dag"},"variable_list":[]},"name":"post_action_delete"}],"type":"AHV_VM","name":"master","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"30","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"CRED"}},"editables":{"readiness_probe":{"retries":true,"delay_secs":true,"timeout_secs":null},"create_spec":{"resources":{"nic_list":{"0":{"subnet_reference":true}},"disk_list":{"1":{"disk_size_mib":true}}}}},"os_type":"Linux","create_spec":{"name":"master-@@{calm_array_index}@@-@@{LB_DNS.ST}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"@@{subnet_ref.uuid}@@"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":4,"gpu_list":[],"memory_size_mib":16384,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":null,"power_state":"ON","type":"","account_uuid":"a0c4dc60-12c4-4199-b476-ddde6a8b9dba","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"IDE"}},"type":"","boot_type":"LEGACY","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"app_package","type":"","name":"RHCOS47_BOOTSTRAP","uuid":"bd750449-d7c5-4ed3-b539-06db21eaf37c"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"IDE"},"device_type":"CDROM"}},{"data_source_reference":null,"type":"","disk_size_mib":122880,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"OpenshiftLB_DNS"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Create SubnetRef"}],"name":"8e2557a0_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"OpenshiftLB_DNS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create SubnetRef","attrs":{"exit_status":[],"script":"subnet_ref={\n                \"kind\": \"subnet\",\n                \"uuid\": \"@@{SUBNET_REF}@@\"\n              }\nprint 'subnet_ref=',json.dumps(subnet_ref)","eval_variables":["subnet_ref"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"34748339_runbook","main_task_local_reference":{"kind":"app_task","name":"8e2557a0_dag"},"variable_list":[]},"name":"pre_action_create"},{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"OpenshiftLB_DNS"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Remove Image from Image Service"}],"name":"77be263b_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"OpenshiftLB_DNS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Remove Image from Image Service","attrs":{"script":"JWT = '@@{calm_jwt}@@'\nImageName ='RHCOS-@@{OPENSHIFT_SUBDOMAIN}@@'\n# Get VM\napi_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/images\/list'\nheaders = {'Content-Type': 'application\/json',  'Accept':'application\/json', 'Authorization': 'Bearer {}'.format(JWT)}\npayload = {'kind':'image'}\nr = urlreq(api_url, verb='POST', headers=headers,params=json.dumps(payload), verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\n# Get Image UUID \nfor entity in resp['entities']:\n  if entity['status']['name'] == ImageName:\n    ImageUUID = entity['metadata']['uuid']\n\napi_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/images\/{}'.format(ImageUUID)\n\nr = urlreq(api_url, verb='DELETE', headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n    taskUuid = resp['status']['execution_context']['task_uuid']\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n    \n   \n# Monitor task\nstate = \"\"\nwhile state != \"SUCCEEDED\":\n    api_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/tasks\/{}'.format(taskUuid)\n\n    sleep(2)\n    r = urlreq(api_url, verb='GET', headers=headers, verify=False)\n    if r.ok:\n        resp = json.loads(r.content)\n        state = resp['status']\n        if state == \"FAILED\":\n            print(\"Task failed\", resp['progress_message'])\n            exit(1)\n\n    else:\n        print(\"Post request failed\", r.content)\n        exit(1)\n\nprint(\"Deleted {} from Image Service\".format(ImageName))\n\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"86ea7a14_runbook","main_task_local_reference":{"kind":"app_task","name":"77be263b_dag"},"variable_list":[]},"name":"post_action_delete"}],"type":"AHV_VM","name":"OpenshiftLB_DNS","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"30","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"CRED"}},"editables":{"create_spec":{"resources":{"guest_customization":true,"num_vcpus_per_socket":true,"num_sockets":true,"memory_size_mib":true}}},"os_type":"Linux","create_spec":{"name":"lbdns-@@{OPENSHIFT_SUBDOMAIN}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[{"ip":"@@{BASTION_IP}@@","type":"ASSIGNED"}],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"@@{subnet_ref.uuid}@@"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":4,"gpu_list":[],"memory_size_mib":6144,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\nusers:\n  - name: @@{CRED.username}@@\n    ssh-authorized-keys:\n      - @@{CRED.public_key}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']"},"type":"","sysprep":null},"power_state":"ON","type":"","account_uuid":"a0c4dc60-12c4-4199-b476-ddde6a8b9dba","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","boot_type":"LEGACY","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"app_package","type":"","name":"OpenshiftC8","uuid":"e9c1920d-9082-485c-9e5f-5c949d2ff93d"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[],"type":"EXISTING_VM","name":"Prov_Check","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{OpenshiftLB_DNS.address}@@","delay_secs":"30","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"CRED"}},"os_type":"Linux","create_spec":{"type":"PROVISION_EXISTING_MACHINE","address":"@@{OpenshiftLB_DNS.address}@@"},"variable_list":[]},{"description":"","action_list":[{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"worker"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Create SubnetRef"}],"name":"82055624_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_substrate","name":"worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create SubnetRef","attrs":{"exit_status":[],"script":"subnet_ref={\n                \"kind\": \"subnet\",\n                \"uuid\": \"@@{SUBNET_REF}@@\"\n              }\nprint 'subnet_ref=',json.dumps(subnet_ref)","eval_variables":["subnet_ref"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"01ba9557_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"82055624_dag_cloned_1"},"variable_list":[]},"name":"pre_action_create"},{"description":"","type":"fragment","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_substrate","name":"worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"7fde6a8e_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"797b9168_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"7fde6a8e_dag_cloned_1"},"variable_list":[]},"name":"post_action_delete"}],"type":"AHV_VM","name":"worker","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"30","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"CRED"}},"editables":{"readiness_probe":{"retries":true,"delay_secs":true,"timeout_secs":null},"create_spec":{"resources":{"nic_list":{"0":{"subnet_reference":true}},"disk_list":{"1":{"disk_size_mib":true}}}}},"os_type":"Linux","create_spec":{"name":"worker-@@{calm_array_index}@@-@@{LB_DNS.ST}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"@@{subnet_ref.uuid}@@"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":4,"gpu_list":[],"memory_size_mib":16384,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":null,"power_state":"ON","type":"","account_uuid":"a0c4dc60-12c4-4199-b476-ddde6a8b9dba","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"IDE"}},"type":"","boot_type":"LEGACY","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"app_package","type":"","name":"RHCOS47_BOOTSTRAP","uuid":"bd750449-d7c5-4ed3-b539-06db21eaf37c"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"IDE"},"device_type":"CDROM"}},{"data_source_reference":null,"type":"","disk_size_mib":122880,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"core","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"CRED","editables":{"secret":true},"cred_class":"static"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Boostrap"}],"name":"Setup","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Setup"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Create DNS Entry"},{"kind":"app_task","name":"Register Bootstrap into LoadBalancer"},{"kind":"app_task","name":"OS Installation"},{"kind":"app_task","name":"Remove ISO Disk"},{"kind":"app_task","name":"Status"}],"name":"5707bf52_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Register Bootstrap into LoadBalancer"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"OS Installation"}},{"from_task_reference":{"kind":"app_task","name":"Create DNS Entry"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Register Bootstrap into LoadBalancer"}},{"from_task_reference":{"kind":"app_task","name":"OS Installation"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Remove ISO Disk"}},{"from_task_reference":{"kind":"app_task","name":"Remove ISO Disk"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Status"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Boostrap"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create DNS Entry","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"88af57fe_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Boostrap"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Register Bootstrap into LoadBalancer","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"e8e1548e_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Boostrap"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"OS Installation","attrs":{"script":"#!\/bin\/bash -e\n#Wait for LB\/DNS to be ready\nLB_DNS_STATUS=\"@@{LB_DNS.ST}@@\"\n\n#Fetch Network Settings\n#GW=$(ip route list dev ens3 | awk ' \/^default\/ {print $3}')\n#IPADDR=$(nmcli d show ens3 | awk ' \/IP4.ADDRESS\/ {print $2}')\n#DNS=$(nmcli d show ens3 | awk ' \/IP4.DNS\/ {print $2}' | xargs -d'\\n'| sed 's\/ \/,\/g')\n\n# Configure ssh agent\nSSH_CRED=\"@@{CRED.secret}@@\"\neval `ssh-agent -s`\nssh-add - <<<\"${SSH_CRED}\"\n\n#Change Local Network to Static\n#sudo nmcli connection mod 'Wired connection 1' \\\n#  ipv4.method manual \\\n#  ipv4.addresses $IPADDR \\\n#  ipv4.gateway $GW \\\n#  ipv4.dns $DNS \\\n#  connection.autoconnect yes\n\nsudo coreos-installer install \/dev\/sda --ignition-url http:\/\/@@{PROVISIONING_VM}@@:8080\/openshift\/bootstrap_@@{OPENSHIFT_SUBDOMAIN}@@.ign --insecure-ignition #--copy-network\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Boostrap"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Remove ISO Disk","attrs":{"script":"JWT = '@@{calm_jwt}@@'\nvmUuid ='@@{id}@@'\n# Get VM\napi_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/vms\/{}'.format(vmUuid)\nheaders = {'Content-Type': 'application\/json',  'Accept':'application\/json', 'Authorization': 'Bearer {}'.format(JWT)}\n\nr = urlreq(api_url, verb='GET', headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\n# Power off VM\ndel resp['status']\n\nresp['spec']['resources']['power_state'] = 'OFF'\n\npayload = resp\n\nr = urlreq(api_url, verb='PUT', params=json.dumps(payload), headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n    taskUuid = resp['status']['execution_context']['task_uuid']\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\n\n# Monitor task\nstate = \"\"\nwhile state != \"SUCCEEDED\":\n    api_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/tasks\/{}'.format(taskUuid)\n\n    sleep(2)\n    r = urlreq(api_url, verb='GET', headers=headers, verify=False)\n    if r.ok:\n        resp = json.loads(r.content)\n        state = resp['status']\n        if state == \"FAILED\":\n            print(\"Task failed\", resp['progress_message'])\n            exit(1)\n\n    else:\n        print(\"Post request failed\", r.content)\n        exit(1)\n\n# Wait for VM to power off\napi_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/vms\/{}'.format(vmUuid)\nr = urlreq(api_url, verb='GET', headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n    power_state = resp['status']['resources']['power_state']\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\nstate = \"\"\nwhile state != \"OFF\":\n    api_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/vms\/{}'.format(vmUuid)\n\n    sleep(2)\n    r = urlreq(api_url, verb='GET', headers=headers, verify=False)\n    if r.ok:\n        resp = json.loads(r.content)\n        state = resp['status']['resources']['power_state']\n        if state == \"FAILED\":\n            print(\"Task failed\", resp['progress_message'])\n            exit(1)\n\n    else:\n        print(\"Post request failed\", r.content)\n        exit(1)\n\n# Remove ISO and Power on VM \ndel resp['status']\n# Remove ISO mount and disk size\ndisk_counter = 0\nfor disk in resp['spec']['resources']['disk_list']:\n  del disk['disk_size_mib']\n  if disk['device_properties']['device_type'] == \"CDROM\":\n    del resp['spec']['resources']['disk_list'][disk_counter]\n  disk_counter += 1\n\n\nresp['spec']['resources']['power_state'] = 'ON'\n\napi_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/vms\/{}'.format(vmUuid)\npayload = resp\n\nr = urlreq(api_url, verb='PUT', params=json.dumps(payload), headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n    taskUuid = resp['status']['execution_context']['task_uuid']\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\n# Monitor task\nstate = \"\"\nwhile state != \"SUCCEEDED\":\n    api_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/tasks\/{}'.format(taskUuid)\n\n    sleep(2)\n    r = urlreq(api_url, verb='GET', headers=headers, verify=False)\n    if r.ok:\n        resp = json.loads(r.content)\n        state = resp['status']\n        if state == \"FAILED\":\n            print(\"Task failed\", resp['progress_message'])\n            exit(1)\n\n    else:\n        print(\"Post request failed\", r.content)\n        exit(1)\n\nprint(\"Removed ISO from Bootstrap and booted into Disk\")\n\n# Wait until VM boots\nsleep(60)\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Boostrap"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Status","attrs":{"exit_status":[],"script":"print 'BOOTSTRAP_STATUS=Done'","eval_variables":["BOOTSTRAP_STATUS"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"20d21b90_runbook","main_task_local_reference":{"kind":"app_task","name":"5707bf52_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Setup"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"a643dfca_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"24fb9eac_runbook","main_task_local_reference":{"kind":"app_task","name":"a643dfca_dag"},"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"SUBSTRATE_IMAGE","service_local_reference_list":[],"name":"OpenshiftC8","version":"","options":{"type":"","name":"OpenshiftC8","resources":{"image_type":"DISK_IMAGE","checksum":{"checksum_algorithm":"","type":"","checksum_value":""},"source_uri":"https:\/\/cloud.centos.org\/centos\/8-stream\/x86_64\/images\/CentOS-Stream-GenericCloud-8-20220125.1.x86_64.qcow2","version":{"product_version":"1.0.0","type":"","product_name":"Openshift-Centos8"},"architecture":"X86_64","type":""},"description":""},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Master"}],"name":"OS Installation","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"OS Installation"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Create DNS Entry"},{"kind":"app_task","name":"Register Master into LoadBalancer"},{"kind":"app_task","name":"Install RHCOS"},{"kind":"app_task","name":"Remove ISO Disk"},{"kind":"app_task","name":"Status"}],"name":"a3bc4919_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Create DNS Entry"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Register Master into LoadBalancer"}},{"from_task_reference":{"kind":"app_task","name":"Register Master into LoadBalancer"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install RHCOS"}},{"from_task_reference":{"kind":"app_task","name":"Install RHCOS"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Remove ISO Disk"}},{"from_task_reference":{"kind":"app_task","name":"Remove ISO Disk"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Status"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create DNS Entry","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"5e78714b_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Register Master into LoadBalancer","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"d9221bb7_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install RHCOS","attrs":{"script":"#!\/bin\/bash -e\n#Wait for Bootstrap to be finished\nBOOTSTRAP_STATUS=\"@@{Boostrap.BOOTSTRAP_STATUS}@@\"\n\n#Fetch Network-Settings\n#GW=$(ip route list dev ens3 | awk ' \/^default\/ {print $3}')\n#IPADDR=$(nmcli d show ens3 | awk ' \/IP4.ADDRESS\/ {print $2}')\n#DNS=$(nmcli d show ens3 | awk ' \/IP4.DNS\/ {print $2}' | xargs -d'\\n'| sed 's\/ \/,\/g')\n\n\n# Configure ssh agent\nSSH_CRED=\"@@{CRED.secret}@@\"\neval `ssh-agent -s`\nssh-add - <<<\"${SSH_CRED}\"\n\n#Configure Local Network as Static\n#sudo nmcli connection mod 'Wired connection 1' \\\n#  ipv4.method manual \\\n#  ipv4.addresses $IPADDR \\\n#  ipv4.gateway $GW \\\n#  ipv4.dns $DNS \\\n#  connection.autoconnect yes\n\nsudo coreos-installer install \/dev\/sda --ignition-url http:\/\/@@{PROVISIONING_VM}@@:8080\/openshift\/master_@@{OPENSHIFT_SUBDOMAIN}@@.ign --insecure-ignition #--copy-network\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Remove ISO Disk","attrs":{"script":"JWT = '@@{calm_jwt}@@'\nvmUuid ='@@{id}@@'\n# Get VM\napi_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/vms\/{}'.format(vmUuid)\nheaders = {'Content-Type': 'application\/json',  'Accept':'application\/json', 'Authorization': 'Bearer {}'.format(JWT)}\n\nr = urlreq(api_url, verb='GET', headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\n# Power off VM\ndel resp['status']\n\nresp['spec']['resources']['power_state'] = 'OFF'\n\npayload = resp\n\nr = urlreq(api_url, verb='PUT', params=json.dumps(payload), headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n    taskUuid = resp['status']['execution_context']['task_uuid']\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\n\n# Monitor task\nstate = \"\"\nwhile state != \"SUCCEEDED\":\n    api_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/tasks\/{}'.format(taskUuid)\n\n    sleep(2)\n    r = urlreq(api_url, verb='GET', headers=headers, verify=False)\n    if r.ok:\n        resp = json.loads(r.content)\n        state = resp['status']\n        if state == \"FAILED\":\n            print(\"Task failed\", resp['progress_message'])\n            exit(1)\n\n    else:\n        print(\"Post request failed\", r.content)\n        exit(1)\n\n# Wait for VM to power off\napi_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/vms\/{}'.format(vmUuid)\nr = urlreq(api_url, verb='GET', headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n    power_state = resp['status']['resources']['power_state']\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\nstate = \"\"\nwhile state != \"OFF\":\n    api_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/vms\/{}'.format(vmUuid)\n\n    sleep(2)\n    r = urlreq(api_url, verb='GET', headers=headers, verify=False)\n    if r.ok:\n        resp = json.loads(r.content)\n        state = resp['status']['resources']['power_state']\n        if state == \"FAILED\":\n            print(\"Task failed\", resp['progress_message'])\n            exit(1)\n\n    else:\n        print(\"Post request failed\", r.content)\n        exit(1)\n\n# Remove ISO and Power on VM \ndel resp['status']\n# Remove ISO mount and disk size\ndisk_counter = 0\nfor disk in resp['spec']['resources']['disk_list']:\n  del disk['disk_size_mib']\n  if disk['device_properties']['device_type'] == \"CDROM\":\n    del resp['spec']['resources']['disk_list'][disk_counter]\n  disk_counter += 1\n\n\nresp['spec']['resources']['power_state'] = 'ON'\n\napi_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/vms\/{}'.format(vmUuid)\npayload = resp\n\nr = urlreq(api_url, verb='PUT', params=json.dumps(payload), headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n    taskUuid = resp['status']['execution_context']['task_uuid']\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\n# Monitor task\nstate = \"\"\nwhile state != \"SUCCEEDED\":\n    api_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/tasks\/{}'.format(taskUuid)\n\n    sleep(2)\n    r = urlreq(api_url, verb='GET', headers=headers, verify=False)\n    if r.ok:\n        resp = json.loads(r.content)\n        state = resp['status']\n        if state == \"FAILED\":\n            print(\"Task failed\", resp['progress_message'])\n            exit(1)\n\n    else:\n        print(\"Post request failed\", r.content)\n        exit(1)\n\nprint(\"Removed ISO from Bootstrap and booted into Disk\")\n\n# Wait until VM boots\nsleep(60)\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Master"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Status","attrs":{"exit_status":[],"script":"print \"MASTER_STATUS=Done\"","eval_variables":["MASTER_STATUS"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"e4f956ad_runbook","main_task_local_reference":{"kind":"app_task","name":"a3bc4919_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"OS Installation"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"22442950_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"3cae7b50_runbook","main_task_local_reference":{"kind":"app_task","name":"22442950_dag"},"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"LB_DNS"}],"name":"Openshift LB DNS Setup","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Openshift LB DNS Setup"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Provisioning Setup"},{"kind":"app_task","name":"Haproxy Setup"},{"kind":"app_task","name":"dnsmasq setup"},{"kind":"app_task","name":"Status"}],"name":"a68d3d79_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Provisioning Setup"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Haproxy Setup"}},{"from_task_reference":{"kind":"app_task","name":"Haproxy Setup"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"dnsmasq setup"}},{"from_task_reference":{"kind":"app_task","name":"dnsmasq setup"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Status"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"LB_DNS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Provisioning Setup","attrs":{"script":"#!\/bin\/bash -e\n\nmkdir -p openshift\ncd openshift\n\n# Install dependencies\n# sudo yum -y update\nsudo yum -y install jq python3 socat haproxy dnsmasq\n\n# Disable selinux\nsudo setenforce 0\nsudo sed -i.bkp -r 's\/(SELINUX=)enforcing\/\\1disabled\/g;s\/^SELINUXTYPE=targeted\/#&\/g' \/etc\/selinux\/config\n\n# Download Openshift installer\ncurl -o openshift-install-linux.tar.gz http:\/\/@@{PROVISIONING_VM}@@:8080\/openshift\/openshift-install-linux.tar.gz\ntar xzf openshift-install-linux.tar.gz\nsudo install -m 755 -o root openshift-install \/sbin\/\n\n# Download Openshift client\ncurl -o openshift-client-linux.tar.gz http:\/\/@@{PROVISIONING_VM}@@:8080\/openshift\/openshift-client-linux.tar.gz\ntar xzf openshift-client-linux.tar.gz\nsudo install -m 755 -o root oc \/sbin\/\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"LB_DNS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Haproxy Setup","attrs":{"script":"#!\/bin\/bash -xe\n\necho \"\"\"#---------------------------------------------------------------------\n# Global settings\n#---------------------------------------------------------------------\nglobal\n\n    log         127.0.0.1 local2\n\n    chroot      \/var\/lib\/haproxy\n    pidfile     \/var\/run\/haproxy.pid\n    maxconn     4000\n    user        haproxy\n    group       haproxy\n    daemon\n\n    # utilize system-wide crypto-policies\n    ssl-default-bind-ciphers PROFILE=SYSTEM\n    ssl-default-server-ciphers PROFILE=SYSTEM\n\n\n    stats socket ipv4@0.0.0.0:9999 level admin\n    stats socket \/var\/run\/haproxy.sock mode 666 level admin\n    stats timeout 2m\n    server-state-file \/etc\/haproxy\/server_state\n\n#---------------------------------------------------------------------\n# common defaults that all the 'listen' and 'backend' sections will\n# use if not designated in their block\n#---------------------------------------------------------------------\n\ndefaults\n    load-server-state-from-file global\n    mode                    http\n    log                     global\n    option                  httplog\n    option                  dontlognull\n    option http-server-close\n    option forwardfor       except 127.0.0.0\/8\n    option                  redispatch\n    retries                 3\n    timeout http-request    10s\n    timeout queue           1m\n    timeout connect         10s\n    timeout client          1m\n    timeout server          1m\n    timeout http-keep-alive 10s\n    timeout check           10s\n    maxconn                 3000\n\n\n#---------------------------------------------------------------------\n# Openshift config\n#---------------------------------------------------------------------\n\nlisten stats\n    bind :9000\n    mode http\n    stats enable\n    stats uri \/\n    monitor-uri \/healthz\n\n\nfrontend openshift-api-server\n    bind *:6443\n    default_backend openshift-api-server\n    mode tcp\n    option tcplog\n\nbackend openshift-api-server\n    balance source\n    mode tcp\n    server-template master 0-2 localhost:6443 check disabled\n    server bootstrap localhost:6443 check\n\nfrontend machine-config-server\n    bind *:22623\n    default_backend machine-config-server\n    mode tcp\n    option tcplog\n\nbackend machine-config-server\n    balance source\n    mode tcp\n    server-template master 0-2 localhost:22623 check disabled\n    server bootstrap localhost:22623 check\n\nfrontend ingress-http\n    bind *:80\n    default_backend ingress-http\n    mode tcp\n    option tcplog\n\nbackend ingress-http\n    balance source\n    mode tcp\n    server-template worker 0-99 localhost:80 check disabled\n    server-template master 0-2 localhost:443 check disabled\n    \nfrontend ingress-https\n    bind *:443\n    default_backend ingress-https\n    mode tcp\n    option tcplog\n\nbackend ingress-https\n    balance source\n    mode tcp\n    server-template worker 0-99 localhost:443 check disabled\n    server-template master 0-2 localhost:443 check disabled\n    \"\"\" | sudo tee \/etc\/haproxy\/haproxy.cfg\n\nsudo systemctl enable haproxy\nsudo systemctl start haproxy","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"LB_DNS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"dnsmasq setup","attrs":{"script":"echo \"@@{address}@@ helper.@@{OPENSHIFT_SUBDOMAIN}@@.@@{BASE_DOMAIN}@@\" | sudo tee -a \/etc\/hosts\necho \"@@{address}@@ api.@@{OPENSHIFT_SUBDOMAIN}@@.@@{BASE_DOMAIN}@@\" | sudo tee -a \/etc\/hosts\necho \"@@{address}@@ api-int.@@{OPENSHIFT_SUBDOMAIN}@@.@@{BASE_DOMAIN}@@\" | sudo tee -a \/etc\/hosts\n\necho \"address=\/.apps.@@{OPENSHIFT_SUBDOMAIN}@@.@@{BASE_DOMAIN}@@\/@@{address}@@\" | sudo tee -a \/etc\/dnsmasq.conf \nsudo systemctl enable dnsmasq\nsudo systemctl start dnsmasq\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"LB_DNS"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Status","attrs":{"exit_status":[],"script":"print 'ST=@@{OPENSHIFT_SUBDOMAIN}@@'","eval_variables":["ST"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"39671816_runbook","main_task_local_reference":{"kind":"app_task","name":"a68d3d79_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Openshift LB DNS Setup"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"ee7f5a7a_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"2ca5fd92_runbook","main_task_local_reference":{"kind":"app_task","name":"ee7f5a7a_dag"},"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"SUBSTRATE_IMAGE","service_local_reference_list":[],"name":"RHCOS47_BOOTSTRAP","version":"","options":{"type":"","name":"RHCOS-@@{OPENSHIFT_SUBDOMAIN}@@","resources":{"image_type":"ISO_IMAGE","checksum":{"checksum_algorithm":"","type":"","checksum_value":""},"source_uri":"http:\/\/@@{PROVISIONING_VM}@@:8080\/openshift\/rhcos-@@{OPENSHIFT_SUBDOMAIN}@@.iso","version":{"product_version":"1.0.0","type":"","product_name":"RHCOS47_BOOTSTRAP"},"architecture":"X86_64","type":""},"description":""},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"OS_Status_Check"}],"name":"Check Openshift status","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Check Openshift status"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Prepare Install"},{"kind":"app_task","name":"Prepare Openshift Install"},{"kind":"app_task","name":"OCP_STATUS Status"},{"kind":"app_task","name":"Remove Bootstrap from LoadBalancer"},{"kind":"app_task","name":"AutoAproval CSR"},{"kind":"app_task","name":"Finish Openshift Install"},{"kind":"app_task","name":"Save HAProxy State"}],"name":"5607dede_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Prepare Install"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Prepare Openshift Install"}},{"from_task_reference":{"kind":"app_task","name":"AutoAproval CSR"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Finish Openshift Install"}},{"from_task_reference":{"kind":"app_task","name":"Remove Bootstrap from LoadBalancer"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"AutoAproval CSR"}},{"from_task_reference":{"kind":"app_task","name":"Prepare Openshift Install"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"OCP_STATUS Status"}},{"from_task_reference":{"kind":"app_task","name":"OCP_STATUS Status"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Remove Bootstrap from LoadBalancer"}},{"from_task_reference":{"kind":"app_task","name":"Finish Openshift Install"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Save HAProxy State"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Prepare Install","attrs":{"exit_status":[],"script":"echo 'export KUBECONFIG=~\/openshift\/auth\/kubeconfig' >> .bash_profile\n\nmkdir -p openshift\/auth\ncd openshift\/auth\necho @@{KUBECONFIGB64}@@ | base64 -d > kubeconfig\necho @@{KUBEADMINB64}@@ | base64 -d > kubeadmin-password\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CRED"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Prepare Openshift Install","attrs":{"script":"#!\/bin\/bash -e\n# Use macro from master set var task to delay task execution\nMASTER_STATUS=\"@@{Master.MASTER_STATUS}@@\"\n\ncd openshift\n# Wait for bootstrap completion\nsudo openshift-install wait-for bootstrap-complete --log-level debug","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"OCP_STATUS Status","attrs":{"exit_status":[],"script":"print \"OCP_STATUS=bootstrap finished\"","eval_variables":["OCP_STATUS"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Remove Bootstrap from LoadBalancer","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"a9b5306a_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"AutoAproval CSR","attrs":{"script":"export KUBECONFIG=~\/openshift\/auth\/kubeconfig\n\necho \"\"\"export KUBECONFIG=~\/openshift\/auth\/kubeconfig\n~\/openshift\/oc get csr -oname | xargs ~\/openshift\/oc adm certificate approve\"\"\" > openshift\/csrjob.sh\nchmod +x openshift\/csrjob.sh\n\n(crontab -l; echo \"* * * * * \/home\/core\/openshift\/csrjob.sh\")|awk '!x[$0]++'|crontab -","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Finish Openshift Install","attrs":{"script":"cd openshift\n# Wait for openshift installation to complete\nsudo openshift-install wait-for install-complete --log-level debug","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Save HAProxy State","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"6f578655_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"e460ecb2_runbook","main_task_local_reference":{"kind":"app_task","name":"5607dede_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Check Openshift status"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"3200b001_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"8eff546d_runbook","main_task_local_reference":{"kind":"app_task","name":"3200b001_dag"},"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Worker"}],"name":"OS Installation_cloned_0","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"OS Installation_cloned_0"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Create DNS Entry"},{"kind":"app_task","name":"Register Worker into LoadBalancer"},{"kind":"app_task","name":"Install RHCOS"},{"kind":"app_task","name":"Remove ISO Disk"},{"kind":"app_task","name":"Status"}],"name":"a3bc4919_dag_cloned_1","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Create DNS Entry"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Register Worker into LoadBalancer"}},{"from_task_reference":{"kind":"app_task","name":"Register Worker into LoadBalancer"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Install RHCOS"}},{"from_task_reference":{"kind":"app_task","name":"Install RHCOS"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Remove ISO Disk"}},{"from_task_reference":{"kind":"app_task","name":"Remove ISO Disk"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Status"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Create DNS Entry","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"57e200d4_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Register Worker into LoadBalancer","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"bd1a1b17_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Install RHCOS","attrs":{"script":"#!\/bin\/bash -e\n#Waiting for Bootstrap to be finished\nBOOTSTRAP_STATUS=\"@@{Boostrap.BOOTSTRAP_STATUS}@@\"\n\n#Fetch Network-Settings\n#GW=$(ip route list dev ens3 | awk ' \/^default\/ {print $3}')\n#IPADDR=$(nmcli d show ens3 | awk ' \/IP4.ADDRESS\/ {print $2}')\n#DNS=$(nmcli d show ens3 | awk ' \/IP4.DNS\/ {print $2}' | xargs -d'\\n'| sed 's\/ \/,\/g')\n\n\n# Configure ssh agent\nSSH_CRED=\"@@{CRED.secret}@@\"\neval `ssh-agent -s`\nssh-add - <<<\"${SSH_CRED}\"\n\n#Change Local Network to Static\n#sudo nmcli connection mod 'Wired connection 1' \\\n#  ipv4.method manual \\\n#  ipv4.addresses $IPADDR \\\n#  ipv4.gateway $GW \\\n#  ipv4.dns $DNS \\\n#  connection.autoconnect yes\n\nsudo coreos-installer install \/dev\/sda --ignition-url http:\/\/@@{PROVISIONING_VM}@@:8080\/openshift\/worker_@@{OPENSHIFT_SUBDOMAIN}@@.ign --insecure-ignition #--copy-network","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Remove ISO Disk","attrs":{"script":"JWT = '@@{calm_jwt}@@'\nvmUuid ='@@{id}@@'\n# Get VM\napi_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/vms\/{}'.format(vmUuid)\nheaders = {'Content-Type': 'application\/json',  'Accept':'application\/json', 'Authorization': 'Bearer {}'.format(JWT)}\n\nr = urlreq(api_url, verb='GET', headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\n# Power off VM\ndel resp['status']\n\nresp['spec']['resources']['power_state'] = 'OFF'\n\npayload = resp\n\nr = urlreq(api_url, verb='PUT', params=json.dumps(payload), headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n    taskUuid = resp['status']['execution_context']['task_uuid']\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\n\n# Monitor task\nstate = \"\"\nwhile state != \"SUCCEEDED\":\n    api_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/tasks\/{}'.format(taskUuid)\n\n    sleep(2)\n    r = urlreq(api_url, verb='GET', headers=headers, verify=False)\n    if r.ok:\n        resp = json.loads(r.content)\n        state = resp['status']\n        if state == \"FAILED\":\n            print(\"Task failed\", resp['progress_message'])\n            exit(1)\n\n    else:\n        print(\"Post request failed\", r.content)\n        exit(1)\n\n# Wait for VM to power off\napi_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/vms\/{}'.format(vmUuid)\nr = urlreq(api_url, verb='GET', headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n    power_state = resp['status']['resources']['power_state']\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\nstate = \"\"\nwhile state != \"OFF\":\n    api_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/vms\/{}'.format(vmUuid)\n\n    sleep(2)\n    r = urlreq(api_url, verb='GET', headers=headers, verify=False)\n    if r.ok:\n        resp = json.loads(r.content)\n        state = resp['status']['resources']['power_state']\n        if state == \"FAILED\":\n            print(\"Task failed\", resp['progress_message'])\n            exit(1)\n\n    else:\n        print(\"Post request failed\", r.content)\n        exit(1)\n\n# Remove ISO and Power on VM \ndel resp['status']\n# Remove ISO mount and disk size\ndisk_counter = 0\nfor disk in resp['spec']['resources']['disk_list']:\n  del disk['disk_size_mib']\n  if disk['device_properties']['device_type'] == \"CDROM\":\n    del resp['spec']['resources']['disk_list'][disk_counter]\n  disk_counter += 1\n\n\nresp['spec']['resources']['power_state'] = 'ON'\n\napi_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/vms\/{}'.format(vmUuid)\npayload = resp\n\nr = urlreq(api_url, verb='PUT', params=json.dumps(payload), headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n    taskUuid = resp['status']['execution_context']['task_uuid']\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\n# Monitor task\nstate = \"\"\nwhile state != \"SUCCEEDED\":\n    api_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/tasks\/{}'.format(taskUuid)\n\n    sleep(2)\n    r = urlreq(api_url, verb='GET', headers=headers, verify=False)\n    if r.ok:\n        resp = json.loads(r.content)\n        state = resp['status']\n        if state == \"FAILED\":\n            print(\"Task failed\", resp['progress_message'])\n            exit(1)\n\n    else:\n        print(\"Post request failed\", r.content)\n        exit(1)\n\nprint(\"Removed ISO from Bootstrap and booted into Disk\")\n\n# Wait until VM boots\nsleep(60)\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Worker"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Status","attrs":{"exit_status":[],"script":"print \"WORKER_STATUS=Done\"","eval_variables":["WORKER_STATUS"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"e4f956ad_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"a3bc4919_dag_cloned_1"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"OS Installation_cloned_0"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"22442950_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"3cae7b50_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"22442950_dag_cloned_1"},"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"decb8265_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Setup"}],"substrate_local_reference":{"kind":"app_substrate","name":"bootstrap"},"variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"name":"9df14f84_deployment","min_replicas":"3","default_replicas":"3","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"3","package_local_reference_list":[{"kind":"app_package","name":"OS Installation"}],"substrate_local_reference":{"kind":"app_substrate","name":"master"},"variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"name":"8ff9c0f1_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Openshift LB DNS Setup"}],"substrate_local_reference":{"kind":"app_substrate","name":"OpenshiftLB_DNS"},"variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"name":"d9d0f80c_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Check Openshift status"}],"substrate_local_reference":{"kind":"app_substrate","name":"Prov_Check"},"variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"name":"4aff8c30_deployment","min_replicas":"2","default_replicas":"@@{WORKER}@@","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"99","package_local_reference_list":[{"kind":"app_package","name":"OS Installation_cloned_0"}],"substrate_local_reference":{"kind":"app_substrate","name":"worker"},"variable_list":[],"description":""}],"environment_reference_list":[],"patch_list":[],"description":"","action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Deploy CSI Driver"}],"name":"425a1dab_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Deploy CSI Driver","attrs":{"exit_status":[],"script":"export KUBECONFIG=~\/openshift\/auth\/kubeconfig\necho \"\"\"apiVersion: v1\nkind: Secret\nmetadata:\n  name: ntnx-secret\n  namespace: ntnx-system\nstringData:\n  key: @@{PE_IP}@@:9440:@@{PE_ADMIN}@@:@@{PE_PW}@@\"\"\" > ntnx-secret.yaml\necho \"\"\"apiVersion: operators.coreos.com\/v1\nkind: OperatorGroup\nmetadata:\n  name: ntnx-system-r8czl\n  namespace: ntnx-system\nspec:\n  targetNamespaces:\n  - ntnx-system\"\"\" > operatorgroup.yaml\necho \"\"\"apiVersion: operators.coreos.com\/v1alpha1\nkind: Subscription\nmetadata:\n  name: nutanixcsioperator\n  namespace: ntnx-system\nspec:\n  channel: beta\n  name: nutanixcsioperator\n  installPlanApproval: Automatic\n  source: certified-operators\n  sourceNamespace: openshift-marketplace\"\"\" > subscription.yaml\necho \"\"\"apiVersion: crd.nutanix.com\/v1alpha1\nkind: NutanixCsiStorage\nmetadata:\n  name: nutanixcsistorage\n  namespace: ntnx-system\nspec:\n  namespace: ntnx-system\"\"\" > instance.yaml\n  \noc create ns ntnx-system\noc create -f ntnx-secret.yaml\noc create -f operatorgroup.yaml\noc create -f subscription.yaml\n\nATTEMPTS=0\nROLLOUT_STATUS_CMD=\"oc wait --for=condition=available --timeout=120s -n ntnx-system deployments nutanix-csi-operator-controller-manager\"\nuntil $ROLLOUT_STATUS_CMD || [ $ATTEMPTS -eq 12 ]; do\n  $ROLLOUT_STATUS_CMD\n  ATTEMPTS=$((attempts + 1))\n  sleep 10\ndone\n\n# Check deployment rollout status every 10 seconds (max 2 minutes) until complete.\nATTEMPTS=0\nROLLOUT_STATUS_CMD=\"oc get NutanixCsiStorage -n ntnx-system\"\nuntil $ROLLOUT_STATUS_CMD || [ $ATTEMPTS -eq 12 ]; do\n  $ROLLOUT_STATUS_CMD\n  ATTEMPTS=$((attempts + 1))\n  sleep 10\ndone\n\noc create -f instance.yaml","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CRED"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"87f0cf03_runbook","main_task_local_reference":{"kind":"app_task","name":"425a1dab_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"PE_PW","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"PE_ADMIN","value":"admin","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"PE_IP","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]},"name":"Deploy CSI"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Enable Image Registry"}],"name":"0be64741_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"OS_Status_Check"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Enable Image Registry","attrs":{"exit_status":[],"script":"export KUBECONFIG=~\/openshift\/auth\/kubeconfig\necho \"\"\"apiVersion: storage.k8s.io\/v1\nkind: StorageClass\nmetadata:\n  name: nutanix-volume\nprovisioner: csi.nutanix.com\nparameters:\n  csi.storage.k8s.io\/provisioner-secret-name: ntnx-secret\n  csi.storage.k8s.io\/provisioner-secret-namespace: ntnx-system\n  csi.storage.k8s.io\/node-publish-secret-name: ntnx-secret\n  csi.storage.k8s.io\/node-publish-secret-namespace: ntnx-system\n  csi.storage.k8s.io\/controller-expand-secret-name: ntnx-secret\n  csi.storage.k8s.io\/controller-expand-secret-namespace: ntnx-system\n  csi.storage.k8s.io\/fstype: ext4\n  dataServiceEndPoint: @@{DS_IP}@@:3260\n  storageContainer: @@{PE_CONTAINER}@@\n  storageType: NutanixVolumes\n  #whitelistIPMode: ENABLED\n  #chapAuth: ENABLED\nallowVolumeExpansion: true\nreclaimPolicy: Delete\"\"\" > storageclass.yaml\necho \"\"\"kind: PersistentVolumeClaim\napiVersion: v1\nmetadata:\n  name: image-registry-claim\n  namespace: openshift-image-registry\nspec:\n  accessModes:\n  - ReadWriteOnce\n  resources:\n    requests:\n      storage: 100Gi\n  storageClassName: nutanix-volume\"\"\" > pvc.yaml\n\noc create -f storageclass.yaml\noc create -f pvc.yaml\n\n# Patch OC Image Registry to use created PVC\noc patch configs.imageregistry.operator.openshift.io cluster --type merge --patch '{\"spec\":{\"managementState\":\"Managed\",\"storage\":{\"pvc\":{\"claim\":\"image-registry-claim\"}},\"rolloutStrategy\": \"Recreate\"}}'\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"CRED"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"0843e467_runbook","main_task_local_reference":{"kind":"app_task","name":"0be64741_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"DS_IP","value":"10.38.15.136","label":"DataServiceIP","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"PE_CONTAINER","value":"Default","label":"Storage Container","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]},"name":"Enable Image Registry"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Scale Out Worker"},{"kind":"app_task","name":"Save HAProxy State"}],"name":"55a70022_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Scale Out Worker"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Save HAProxy State"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_blueprint_deployment","name":"4aff8c30_deployment"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Scale Out Worker","attrs":{"scaling_count":"@@{SCALEOUT_WORKER}@@","type":"","scaling_type":"SCALEOUT"},"timeout_secs":"0","type":"SCALING","variable_list":[]},{"target_any_local_reference":{"kind":"app_blueprint_deployment","name":"d9d0f80c_deployment"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Save HAProxy State","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"6f578655_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"1fd3a13a_runbook","main_task_local_reference":{"kind":"app_task","name":"55a70022_dag"},"variable_list":[{"regex":{"should_validate":false,"value":"^[\\d]*$"},"val_type":"INT","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"SCALEOUT_WORKER","value":"","label":"Scale out number of Workers","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]},"name":"Scale Out"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Scale In"},{"kind":"app_task","name":"Save HAProxy State"}],"name":"5cdabf34_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Scale In"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Save HAProxy State"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_blueprint_deployment","name":"4aff8c30_deployment"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Scale In","attrs":{"scaling_count":"@@{SCALEIN_WORKER}@@","type":"","scaling_type":"SCALEIN"},"timeout_secs":"0","type":"SCALING","variable_list":[]},{"target_any_local_reference":{"kind":"app_blueprint_deployment","name":"d9d0f80c_deployment"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Save HAProxy State","attrs":{"type":"CALL_RUNBOOK","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"6f578655_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"da7a7a68_runbook","main_task_local_reference":{"kind":"app_task","name":"5cdabf34_dag"},"variable_list":[{"regex":{"should_validate":false,"value":"^[\\d]*$"},"val_type":"INT","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"SCALEIN_WORKER","value":"1","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]},"name":"Scale In"}],"name":"MasterWorker","restore_config_list":[],"snapshot_config_list":[],"variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"BASE_DOMAIN","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"OPENSHIFT_SUBDOMAIN","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"PROVISIONING_VM","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"MACHINE_NETWORK","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"KUBECONFIGB64","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"KUBEADMINB64","value":"","label":"","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"SUBNET_REF","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"WORKER","value":"2","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"BASTION_IP","value":"","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"CRED"},"type":"USER"},"name":"OCP-MasterWorker"},"api_version":"3.0","metadata":{"last_update_time":"1644734807812327","kind":"blueprint","spec_version":2,"creation_time":"1644734584410518","name":"OCP-MasterWorker"}}